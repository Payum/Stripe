{# https://gist.github.com/briancollins/6365455 #}

{% extends layout ?: "@PayumCore/layout.html.twig" %}

{% block payum_body %}
    {{ parent() }}

    <!-- First form, shown to use. Second form sent to server -->
    <form action="{{ actionUrl|default('') }}" method="POST" id="payum_stripe_js-payment-form">
        <span class="payment-errors"></span>

        <div class="form-row">
            <label>
                <span>Card Number</span>
                <input type="text" size="20" data-stripe="number"/>
            </label>
        </div>

        <div class="form-row">
            <label>
                <span>CVC</span>
                <input type="text" size="4" data-stripe="cvc"/>
            </label>
        </div>

        <div class="form-row">
            <label>
                <span>Expiration (MM/YYYY)</span>
                <input type="text" size="2" data-stripe="exp-month"/>
            </label>
            <span> / </span>
            <input type="text" size="4" data-stripe="exp-year"/>
        </div>
        <button type="submit">Submit Payment</button>
    </form>
    <form action="{{ actionUrl|default('') }}" method="POST">
        <input type="hidden" name="stripeToken" id="payum_stripe_js-token" />
    </form>
{% endblock %}

{% block payum_vendor_javascripts %}
    {{ parent() }}

    <!-- The required Stripe lib -->
    <script type="text/javascript" src="https://js.stripe.com/v2/"></script>
{% endblock %}

{% block payum_javascripts %}
    {{ parent() }}

    <script type="text/javascript">
        document.getElementById('payum_stripe_js-payment-form').addEventListener('submit', function (e) {
            // Prevent form submission
            if (e && e.preventDefault) {
                e.preventDefault();
            }
            var form = this;
            var stripeResponseHandler = function(status, response) {
                // Enable the form again
                els[0].disabled = false;
                
                if (response.error) {
                    // Show the errors on the form
                    form.getElementsByClassName('payment-errors')[0].innerText = response.error.message;
                    return false;
                }
                // token contains id, last4, and card type
                var token = response.id;
                // Insert the token into the form so it gets submitted to the server
                var el = document.getElementById('payum_stripe_js-token');
                el.value = token;
                // and re-submit
                el.parentNode.submit();
            };
            
            var els = form.getElementsByTagName('button');
            
            // If the button is already disabled, stop here to prevent duplicates
            if (els[0].disabled) {
                return false;
            }
            
            // Disable the submit button to prevent repeated clicks
            els[0].disabled = true;

            // This identifies your website in the createToken call below
            Stripe.setPublishableKey({{ publishable_key|json_encode|raw }});

            Stripe.card.createToken(form, stripeResponseHandler);
            
            // Prevent native form submission
            return false;
        }, false);
    </script>

{% endblock %}
